<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banco de Exámenes - San Luis Gonzaga</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
    <!-- PDF.js para mostrar la primera página -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        :root {
            --bg-dark: #0f172a;
            --surface: #1e293b;
            --text: #e2e8f0;
            --text-light: #94a3b8;
            --azul-marino: #1e40af;
            --amarillo: #fbbf24;
            --rojo: #dc2626;
            --border: #334155;
            --radius: 24px;
            --shadow: 0 15px 40px rgba(0,0,0,0.5);
        }

        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            position: relative;
        }

        /* Menú desplegable con scroll */
        .sidebar {
            position: fixed;
            left: -300px;
            top: 0;
            width: 300px;
            height: 100vh;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: white;
            z-index: 1000;
            transition: left 0.4s ease;
            box-shadow: 5px 0 30px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
        }

        .sidebar.active { left: 0; }

        .sidebar-header {
            padding: 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
            text-align: center;
        }

        .logo {
            width: 130px;
            border-radius: 50%;
            padding: 1rem;
            background: rgba(251,191,36,0.2);
            border: 4px solid var(--amarillo);
            margin: 0 auto 1rem;
        }

        .sidebar h2 { font-size: 1.9rem; font-weight: 900; color: white; }

        .nav-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
        }

        .nav a {
            display: block;
            padding: 1.2rem 2rem;
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav a:hover {
            background: rgba(251,191,36,0.2);
            color: var(--amarillo);
            padding-left: 2.5rem;
        }

        .nav a.volver {
            margin: 0 2rem 2rem;
            background: var(--rojo);
            color: white !important;
            border-radius: 20px;
            font-weight: 900;
            font-size: 1.1rem;
            padding: 1.4rem;
            box-shadow: 0 10px 30px rgba(220,38,38,0.5);
            order: -1;
        }

        .nav a.volver:hover {
            background: #b91c1c;
            transform: translateY(-4px);
        }

        .menu-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--azul-marino);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
        }

        .menu-toggle:hover { background: var(--amarillo); color: #000; }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
            z-index: 999;
        }

        .overlay.active { opacity: 1; visibility: visible; }

        .hero {
            min-height: 100vh;
            background: linear-gradient(rgba(15,23,42,0.95), rgba(15,23,42,0.85)),
                        url('https://images.unsplash.com/photo-1523050858586-39f6d5e6b870?w=1920') center/cover;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 6rem 2rem 4rem;
        }

        .hero h1 {
            font-size: clamp(3.8rem, 9vw, 8rem);
            font-weight: 900;
            color: var(--amarillo);
            margin-bottom: 1rem;
        }

        .hero p { font-size: 1.7rem; color:
        var(--text-light); max-width: 900px; }

        .container { max-width: 1400px; margin: 0 auto; padding: 4rem 2rem; text-align: center; }

        .section-title {
            font-size: 3.2rem;
            font-weight: 900;
            color: var(--amarillo);
            margin: 6rem 0 4rem;
        }

        .section-title::after {
            content: '';
            display: block;
            width: 150px;
            height: 8px;
            background: linear-gradient(90deg, var(--amarillo), var(--rojo));
            margin: 1rem auto;
            border-radius: 4px;
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 3rem;
            justify-content: center;
            justify-items: center;
        }

        .card {
            width: 100%;
            max-width: 380px;
            background: var(--surface);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.4s ease;
        }

        .card:hover { transform: translateY(-15px); }

        .card-img-container {
            width: 100%;
            height: 220px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .card-img-container canvas {
            max-width: 100%;
            max-height: 100%;
        }

        .card-content { padding: 2rem; }

        .badge {
            background: var(--azul-marino);
            color: white;
            padding: 0.6rem 1.6rem;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.85rem;
            display: inline-block;
            margin-bottom: 1rem;
        }

        .card h3 { font-size: 1.55rem; font-weight: 800; color: white; margin: 1rem 0; }

        .card p { color: var(--text-light); margin-bottom: 1.5rem; }

        .btns { display: flex; justify-content: center; gap: 1rem; }

        .btn {
            flex: 1;
            padding: 1rem;
            border-radius: 16px;
            font-weight: 700;
            font-size: 0.95rem;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .btn-primary { background: var(--azul-marino); color: white; }
        .btn-success { background: var(--amarillo); color: #000; }
        .btn-danger { background: var(--rojo); color: white; }
        .btn:hover { transform: scale(1.05); }

        .upload-box {
            text-align: center;
            background: var(--surface);
            border: 3px dashed var(--azul-marino);
            border-radius: var(--radius);
            padding: 4rem 2rem;
            margin: 7rem auto;
            max-width: 900px;
            box-shadow: var(--shadow);
        }

        .upload-box h3 { font-size: 2.3rem; font-weight: 900; color: var(--amarillo); }

        .btn-upload {
            background: linear-gradient(135deg, var(--azul-marino), var(--amarillo));
            color: white;
            padding: 1.4rem 4rem;
            border: none;
            border-radius: 50px;
            font-size: 1.4rem;
            font-weight: 900;
            cursor: pointer;
            margin-top: 1.5rem;
            box-shadow: var(--shadow);
        }

        .btn-upload:hover { transform: translateY(-6px) scale(1.08); }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.97);
            backdrop-filter: blur(12px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 3rem;
            max-width: 560px;
            width: 95%;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .modal h3 {
            font-size: 2.2rem;
            color: var(--amarillo);
            margin-bottom: 2rem;
            font-weight: 800;
        }

        #examTitle {
            width: 100%;
            padding: 1.2rem;
            border-radius: 16px;
            border: none;
            background: #334155;
            color: white;
            font-size: 1.1rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        #examTitle::placeholder { color: #94a3b8; }

        .file-input {
            display: block;
            background: #fef3c7;
            border: 3px dashed var(--azul-marino);
            border-radius: 20px;
            padding: 2.8rem 2rem;
            cursor: pointer;
            margin: 2rem auto;
            font-weight: 700;
            color: #000 !important;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            max-width: 420px;
        }

        .file-input:hover {
            background: #fde68a;
            transform: scale(1.02);
        }

        #fileInfo {
            color: var(--amarillo);
            font-weight: 700;
            margin: 1.5rem 0;
            font-size: 1.1rem;
        }

        #uploadBtn {
            background: linear-gradient(135deg, var(--azul-marino), var(--amarillo));
            color: white;
            padding: 1.4rem 4rem;
            border: none;
            border-radius: 50px;
            font-size: 1.4rem;
            font-weight: 900;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
            box-shadow: var(--shadow);
        }

        .progress {
            height: 16px;
            background: var(--border);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 1.5rem;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--azul-marino), var(--amarillo));
            width: 0%;
            transition: width 0.6s ease;
        }

        .close {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 2.8rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .empty {
            text-align: center;
            padding: 5rem;
            color: var(--text-light);
            font-size: 1.4rem;
        }
    </style>
</head>
<body>

    <button class="menu-toggle" onclick="toggleMenu()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="overlay" onclick="toggleMenu()"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="Insignia-New-cuadrado.png" alt="Logo" class="logo" onerror="this.style.display='none'">
            <h2>Banco de<br>Exámenes</h2>
        </div>
        <div class="nav-container">
            <nav class="nav">
                <a href="index.php" class="volver">Volver a Biblioteca</a>
                <a href="#inicio">Inicio</a>
                <a href="#area1">Área I</a>
                <a href="#area2">Área II</a>
                <a href="#area3">Área III</a>
                <a href="#area4">Área IV</a>
                <a href="#area5">Área V</a>
                <a href="#area6">Concursos Interescolares</a>
            </nav>
        </div>
    </aside>

    <section class="hero" id="inicio">
        <h1>BANCO DE EXÁMENES</h1>
        <p>Comparte y descarga exámenes organizados por áreas • Incluye Concursos Interescolares</p>
    </section>

    <div class="container">
        <?php 
        $areas = ['area1','area2','area3','area4','area5','area6'];
        $nombres = ['Área I','Área II','Área III','Área IV','Área V','Concursos Interescolares'];
        for($i = 0; $i < 6; $i++): 
            $area = $areas[$i];
            $lista = array_filter($examenes, fn($e) => ($e['area'] ?? '') === $area);
        ?>
            <h2 class="section-title" id="<?= $area ?>"><?= $nombres[$i] ?></h2>
            
            <div class="cards" id="cards<?= $i+1 ?>">
                <?php if(!empty($lista)): foreach($lista as $examen): ?>
                    <div class="card" data-id="<?= $examen['id'] ?>">
                        <div class="card-img-container">
                            <canvas id="pdf-preview-<?= $examen['id'] ?>"></canvas>
                        </div>
                        <div class="card-content">
                            <div class="badge"><?= $nombres[$i] ?></div>
                            <h3><?= htmlspecialchars($examen['titulo']) ?></h3>
                            <p><?= $examen['fecha_subida'] ?></p>
                            <div class="btns">
                                <a href="<?= $examen['pdf'] ?>" target="_blank" class="btn btn-primary">Ver</a>
                                <a href="<?= $examen['pdf'] ?>" download class="btn btn-success">Descargar</a>
                                <button onclick="eliminarExamen('<?= $examen['id'] ?>', this)" class="btn btn-danger">Eliminar</button>
                            </div>
                        </div>
                    </div>
                <?php endforeach; else: ?>
                    <p class="empty">Aún no hay archivos en esta sección</p>
                <?php endif; ?>
            </div>

            <div class="upload-box">
                <h3>¿Tienes archivos de <?= $nombres[$i] ?>?</h3>
                <p>Sube y ayuda a tus compañeros</p>
                <button class="btn-upload" onclick="openModal('<?= $area ?>')">SUBIR AHORA</button>
            </div>
        <?php endfor; ?>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">x</span>
            <h3 id="modalTitle">Subir archivo</h3>
            <input type="text" id="examTitle" placeholder="Ej: Olimpiada Matemática 2025">
            <label class="file-input" for="fileInput">
                Máximo 140MB • Solo PDF
            </label>
            <input type="file" id="fileInput" accept=".pdf" style="display:none;">
            <div id="fileInfo"></div>
            <button id="uploadBtn" class="btn-upload">SUBIR ARCHIVO</button>
            <div class="progress" id="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
    </div>

    <script>
        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }

        let currentArea = '';
        function openModal(area) {
            currentArea = area;
            const nombre = area === 'area6' ? 'Concursos Interescolares' : 'Área ' + area.replace('area','');
            document.getElementById('modalTitle').textContent = `Subir a ${nombre}`;
            document.getElementById('examTitle').value = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').textContent = '';
            document.getElementById('progress').style.display = 'none';
            document.getElementById('modal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        document.getElementById('fileInput').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                const size = (file.size / 1024 / 1024).toFixed(1);
                document.getElementById('fileInfo').textContent = `${file.name} (${size} MB)`;
            }
        });

        document.getElementById('uploadBtn').addEventListener('click', () => {
            const title = document.getElementById('examTitle').value.trim();
            const file = document.getElementById('fileInput').files[0];
            if (!title || !file || file.size > 140*1024*1024) {
                alert('Completa todos los campos correctamente');
                return;
            }

            const formData = new FormData();
            formData.append('pdf_file', file);
            formData.append('titulo', title);
            formData.append('area', currentArea);

            const btn = document.getElementById('uploadBtn');
            btn.disabled = true; btn.textContent = 'Subiendo...';
            document.getElementById('progress').style.display = 'block';
            document.getElementById('progressBar').style.width = '80%';

            fetch('', { method: 'POST', body: formData })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            })
            .finally(() => {
                btn.disabled = false; btn.textContent = 'SUBIR ARCHIVO';
                document.getElementById('progress').style.display = 'none';
                document.getElementById('progressBar').style.width = '0%';
            });
        });

        function eliminarExamen(id, btn) {
            if (!confirm('¿Eliminar permanentemente?')) return;
            const card = btn.closest('.card');
            fetch('', { method: 'POST', headers: {'Content-Type':'application/x-www-form-urlencoded'}, body: 'eliminar=1&id='+id })
            .then(r => r.json())
            .then(d => { if (d.success) gsap.to(card, { y: -60, opacity: 0, duration: 0.6, onComplete:()=>card.remove() }); });
        }

        // Renderizar vista previa del PDF
        function renderPDF(url, canvas) {
            pdfjsLib.getDocument(url).promise.then(pdf => {
                pdf.getPage(1).then(page => {
                    const viewport = page.getViewport({ scale: 1.5 });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport });
                });
            }).catch(() => {
                canvas.parentElement.innerHTML = '<div style="color:#666;padding:2rem;">Vista previa no disponible</div>';
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('canvas[id^="pdf-preview-"]').forEach(canvas => {
                const card = canvas.closest('.card');
                const pdfUrl = card.querySelector('a[href$=".pdf"]').href;
                renderPDF(pdfUrl, canvas);
            });
            gsap.from('.card', { y: 70, opacity: 0, stagger: 0.12, duration: 0.8, ease: "back.out(1.5)" });
        });

        window.addEventListener('click', e => { if (e.target === document.getElementById('modal')) closeModal(); });
    </script>
    
</body>
</html>
<?php
error_reporting(0);
ini_set('display_errors', 0);

ini_set('upload_max_filesize', '150M');
ini_set('post_max_size', '160M');
ini_set('max_execution_time', 600);
ini_set('memory_limit', '512M');

ob_start();
header('Content-Type: text/html; charset=UTF-8');
header('X-Content-Type-Options: nosniff');

$json_file  = 'examenes.json';
$upload_dir = 'uploads/';
if (!is_dir($upload_dir)) mkdir($upload_dir, 0755, true);

// === SUBIDA DE PDF ===
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['pdf_file']) && $_FILES['pdf_file']['error'] === UPLOAD_ERR_OK) {
    header('Content-Type: application/json; charset=utf-8');
    $titulo = trim($_POST['titulo'] ?? '');
    $area   = $_POST['area'] ?? '';
    if (empty($titulo) || empty($area)) { echo json_encode(['success'=>false,'error'=>'Faltan datos']); exit; }

    $file = $_FILES['pdf_file'];
    if ($file['size'] > 140*1024*1024 || $file['type'] !== 'application/pdf') {
        echo json_encode(['success'=>false,'error'=>'PDF inválido o muy grande']); exit;
    }

    $filename = 'examen_' . uniqid() . '_' . time() . '.pdf';
    $ruta_pdf = $upload_dir . $filename;
    if (!move_uploaded_file($file['tmp_name'], $ruta_pdf)) {
        echo json_encode(['success'=>false,'error'=>'Error al guardar']); exit;
    }

    $nuevo = [
        'id' => uniqid('exam_'),
        'titulo' => htmlspecialchars($titulo, ENT_QUOTES, 'UTF-8'),
        'pdf' => $ruta_pdf,
        'area' => $area,
        'fecha_subida' => date('d/m/Y H:i')
    ];

    $lista = file_exists($json_file) ? json_decode(file_get_contents($json_file), true) : [];
    if (!is_array($lista)) $lista = [];
    array_unshift($lista, $nuevo);
    file_put_contents($json_file, json_encode($lista, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
    echo json_encode(['success' => true, 'examen' => $nuevo]);
    exit;
}

// === ELIMINAR ===
if (isset($_POST['eliminar']) && !empty($_POST['id'])) {
    header('Content-Type: application/json; charset=utf-8');
    $id = $_POST['id'];
    $lista = file_exists($json_file) ? json_decode(file_get_contents($json_file), true) : [];
    foreach ($lista as $k => $e) {
        if ($e['id'] === $id) {
            if (file_exists($e['pdf'])) @unlink($e['pdf']);
            unset($lista[$k]);
            break;
        }
    }
    $lista = array_values($lista);
    file_put_contents($json_file, json_encode($lista, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
    echo json_encode(['success' => true]);
    exit;
}

// === CARGAR EXÁMENES ===
$examenes = file_exists($json_file) ? json_decode(file_get_contents($json_file), true) : [];
if (!is_array($examenes)) $examenes = [];

ob_end_flush();
?>




